#!/usr/bin/env bash
# SPDX-License-Identifier: MIT                                                 
# Copyright (c) 2020-2022 Advanced Micro Devices, Inc. All rights reserved.
GPUFORT_BIN_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# check if required python packages are installed
requirements=$(grep -v "^\s*#" $GPUFORT_BIN_DIR/../python/requirements.txt | grep "^\w\+")
declare -i requirements_missing 
requirements_missing=0 # 0: 'false', >0: true
for m in $requirements; do 
  python3 -c "import $m" &> /dev/null
  retval="$(echo $?)"
  requirements_missing="$requirements_missing + $retval" 
  if (( retval > 0 )); then
    echo "ERROR: Could not find python3 module '$m'. Please install or add to path."
  fi
done
if (( requirements_missing > 0 )); then
  echo "Please install missing python3 packages e.g. via:"
  echo "python3 -m pip install -r <gpufort_root>/python3-requirements.txt"
  echo "(you might need to be root)"
  exit 20
fi

# all dependencies are met and we can continue

for a in "$@"; do
  if [ "$a" == "--print-grammar" ]; then
    printf "\n-------------------\n"
    printf "BEGIN GPUFORT GRAMMAR"
    printf "\n-------------------\n\n"
    GRAMMAR_DIR=${GPUFORT_BIN_DIR}/../python/grammar
    cat ${GRAMMAR_DIR}/grammar_f03.py.in
    cat ${GRAMMAR_DIR}/grammar_directives.py.in
    cat ${GRAMMAR_DIR}/grammar_cuf.py.in
    cat ${GRAMMAR_DIR}/grammar_acc.py.in
    cat ${GRAMMAR_DIR}/grammar_gpufort_control.py.in
    cat ${GRAMMAR_DIR}/grammar_epilog.py.in
    printf "\n-------------------\n"
    printf "END GPUFORT GRAMMAR"
    printf "\n-------------------\n"
    USED_DEVELOPER_TOOL=1
  fi
done 

if [ -z ${USED_DEVELOPER_TOOL} ]; then
  python3 $GPUFORT_BIN_DIR/../python/converter.py --working-dir $(pwd) "${@}" ${GPUFORT_APPEND_FLAGS}
fi
